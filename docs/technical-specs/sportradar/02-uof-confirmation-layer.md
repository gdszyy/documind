---
title: Sportradar UOF 确认层消息处理规范
category: standard
type: integration
version: 2.0
status: active
createdAt: 2025-12-07
updatedAt: 2025-12-08
author: Manus AI
tags:
  - sportradar
  - uof
  - confirmation
  - settlement
  - data-source
  - integration
description: Sportradar Unified Odds Feed 确认层消息类型、官方结算机制和冲正处理的完整技术规范
reference: https://docs.sportradar.com/uof/en/overview
---

# Sportradar UOF 确认层消息处理规范

---

## 1. 确认层概述

确认层（Official Confirmation Layer）消息是 Sportradar UOF 双层信息处理机制的第二层，主要来源于 **官方数据源** 和 **Betradar Control 系统**。这些消息是保证业务准确性和资金安全的最后防线。

**核心特点**：

- **权威性优先**：代表官方最终确认的结果，具有最高优先级，必须覆盖实时层数据。
- **不可逆性**：确认层的操作（如 `certainty=2` 的结算）一旦生效，不应被实时层覆盖。
- **事务性**：所有涉及资金的操作必须在同一数据库事务中完成，保证原子性。
- **可追溯性**：所有确认层操作必须详细记录日志，用于审计和问题追溯。

---

## 2. 核心消息类型分析

### 2.1. bet_settlement (官方结算消息)

#### 2.1.1. 消息定位

`bet_settlement` 是确认层 **最核心** 的消息，承载着注单结算的官方结果。它是双层机制中 `certainty` 字段的核心体现，是所有结算操作的最终依据。

#### 2.1.2. 核心字段业务含义

| 字段名 | 数据类型 | 业务含义 | 双层机制中的作用 |
| :--- | :--- | :--- | :--- |
| `event_id` | 字符串 | 赛事唯一标识符 | 关联实时层和确认层的同一赛事。 |
| **`certainty`** | 整数 | **结算结果的确定性级别** | **双层机制的核心字段**：`1` (Live Scout 实时), `2` (官方确认)。 |
| `result` | 整数 | 结果状态 | `0`: 输, `1`: 赢, `-1`: 待定。 |
| `void_factor` | 浮点数 | 作废系数 | `1.0`: 全额退款, `0.5`: 半额退款。 |
| `timestamp` | 长整型 | 消息生成时间戳 | **确认层关键**：确保官方结果的时效性。 |

#### 2.1.3. 确认层标准变体与业务处理

| 变体名称 | `certainty` | 描述 | 确认层业务反应 |
| :--- | :--- | :--- | :--- |
| **官方确认结算** | `2` | 官方确认的最终结果 | **强制覆盖**：必须覆盖所有 `certainty=1` 的结果。如果之前已按 `certainty=1` 派彩，且结果不一致，需执行**冲正**（扣回已派彩金额）。 |
| **实时初步结算** | `1` | Live Scout 的初步结果 | **临时结算**：可以先按此结果派彩，但需标记为"待确认"。**必须**等待 `certainty=2` 的最终确认。 |
| **注单作废** | `1` 或 `2` | `void_factor` 为 `1.0` 或 `0.5` | **退款处理**：根据 `void_factor` 计算退款金额，更新注单状态为"已作废"。 |

#### 2.1.4. 确认层异常处理

| 异常场景 | 确认层处理方案 | 评估 |
| :--- | :--- | :--- |
| **结果冲突** | `certainty=2` 的结果与 `certainty=1` 的不同 | **强制以 `certainty=2` 为准**，执行冲正操作。这是**极高优先级**的业务逻辑。 | **极高** |
| **消息乱序** | 基于 `certainty` 和 `timestamp` 进行幂等性处理 | **必须**确保 `certainty=2` 的消息优先级高于 `certainty=1`，即使时间戳更早。 | **极高** |
| **注单匹配失败** | 消息中的 ID 在本地数据库找不到 | 记录错误并报警，可能意味着本地数据同步存在问题。 | **高** |

---

### 2.2. odds_change (赔率更新消息 - 确认层视角)

#### 2.2.1. 消息定位

尽管 `odds_change` 通常被认为是实时层的核心消息，但它同样会出现在确认层。确认层的 `odds_change` 消息主要由 **Betradar Control 系统** (`product=3`) 或其他官方生产者发出，用于提供权威的赔率和比赛状态更新。

与实时层追求速度不同，确认层的 `odds_change` 追求的是 **准确性** 和 **权威性**。

#### 2.2.2. 核心字段业务含义

| 元素/属性 | 业务含义 | 确认层处理要点 |
| :--- | :--- | :--- |
| `product` | 消息来源产品 | **核心识别字段**：通过 `product` 值（如 `3`）来区分这是来自确认层而非实时层 (`product=1`) 的消息。 |
| `sport_event_status` | 权威的比赛状态 | 确认层的 `sport_event_status` 包含官方确认的比分、比赛状态、比赛时间、暂停状态、赛段比分等信息，其优先级高于实时层。这些信息是结算和统计的最终依据。 |

    *   **权威的比赛时间与状态**：确认层消息中的 `match_time`, `remaining_time`, `stopped` 等属性是比赛进程的最终记录。
    *   **权威的赛段比分**：确认层消息中的 `<period_scores>` 子元素提供了官方确认的各赛段比分，用于结算与赛段相关的市场。
| `market.status` | 权威的盘口状态 | 确认层发送的盘口状态 (`active`, `suspended`, `deactivated`) 是最终决定，应覆盖实时层的状态。详见 **2.7 市场状态生命周期**。 |
| `outcome.odds` | 权威的赔率 | 这是官方确认的赔率，用于修正可能因实时数据错误导致的赔率偏差。 |

#### 2.2.3. 确认层标准变体与业务处理

| 变体名称 | 描述 | 确认层业务反应 |
| :--- | :--- | :--- |
| **权威赔率更新** | 收到来自确认层生产者 (`product=3` 等) 的 `odds_change` 消息。 | **强制覆盖**：使用消息中的赔率、盘口状态和比赛状态，覆盖当前数据库中来自实时层的数据。 |
| **官方状态同步** | 收到仅包含 `sport_event_status` 更新的 `odds_change` 消息（即 `<odds/>` 元素为空）。 | **权威更新比赛状态**：使用消息中的比分、比赛时间等信息，强制更新赛事状态。 |

---

### 2.3. bet_cancel (注单取消消息)

#### 2.3.1. 消息定位

`bet_cancel` 是确认层的控制消息，用于处理因**错误**导致的投注取消和退款。它与实时层的 `bet_stop`（临时暂停）不同，是**永久性的取消操作**。

#### 2.3.2. 核心字段业务含义

| 字段名 | 业务含义 | 双层机制中的作用 |
| :--- | :--- | :--- |
| `event_id` | 赛事唯一标识符 | 确定取消范围。 |
| `start_time` / `end_time` | 取消的时间范围 | 精确控制哪些时间段的注单需要取消。 |
| `market.id` | 被取消的市场 ID | 可以针对特定市场取消。 |
| `void_reason` | 取消原因代码 | 提供取消的业务依据。 |

#### 2.3.3. 确认层业务处理

- **全量赛事取消**：查找符合 `event_id` 和时间范围的注单，更新状态为"已取消"并全额退款。
- **市场部分取消**：仅取消指定市场的注单。**如果注单已结算，必须先执行反结算**。
- **Outright 赛事 ID 替换**：将注单关联的 `event_id` 更新为新值，或直接取消退款。

---

### 2.4. rollback_bet_settlement (结算回滚消息)

#### 2.4.1. 消息定位

`rollback_bet_settlement` 是确认层的修正消息，用于撤销之前因**错误**发送的 `bet_settlement` 消息。

#### 2.4.2. 确认层业务处理

| 业务环节 | 确认层业务反应 |
| :--- | :--- |
| **定位注单** | 根据 `event_id` 和 `market.id` 查找所有已结算的注单。 |
| **状态回滚** | 将注单状态从"已派彩/已输"更新为"未结算"。 |
| **资金回滚** | **核心操作**：从用户账户中扣除已派发的彩金。 |
| **事务处理** | **必须**在同一数据库事务中完成状态回滚和资金回滚。 |

---

### 2.5. rollback_bet_cancel (取消回滚消息)

#### 2.5.1. 消息定位

`rollback_bet_cancel` 是确认层的恢复消息，用于撤销之前因**错误**发送的 `bet_cancel` 消息，恢复盘口和注单状态。

#### 2.5.2. 确认层业务处理

| 业务环节 | 确认层业务反应 |
| :--- | :--- |
| **恢复注单** | 将被错误取消的注单状态恢复为"待定"。 |
| **资金回滚** | **如果已退款**，需从用户账户中扣回已退还的金额。 |
| **恢复盘口** | 将盘口状态恢复到取消前的状态（如"开放"）。 |

---

### 2.6. fixture_change (赛事变更通知 - 官方变更)

#### 2.6.1. 消息定位

在确认层，`fixture_change` 主要用于通知**赛事取消**、**赛事格式变更**等重大变更。

#### 2.6.2. 确认层关注的变体

| 变体名称 | `change_type` | 确认层业务反应 |
| :--- | :--- | :--- |
| **CANCELLED** | `3` | **永久取消**：更新赛事状态为"Cancelled"，所有盘口暂停，并**触发注单按"Void"结算**。这是确认层的权威操作。 |
| **FORMAT** | `4` | **重新评估**：调用 API 获取完整信息，可能需要重新生成盘口。 |
| **COVERAGE** | `5` | **覆盖变更**：如果 Live 覆盖取消，Live 盘口关闭，切换到 Pre-match 模式。 |

---

### 2.7. 市场状态生命周期与处理 (确认层视角)

在确认层，市场状态（`market.status`）的管理与最终的结算和数据权威性密切相关。虽然市场状态的实时变化主要由实时层处理，但确认层负责定义这些状态的最终性和权威性。

#### 2.7.1. 完整的市场状态列表 (确认层视角)

| Status ID | 状态名称 | 业务含义 | 确认层处理要点 |
| :--- | :--- | :--- | :--- |
| **1** | **Active (活跃)** | 赔率已提供，可以接受投注。 | 确认层发送的 `Active` 状态是权威的，用于纠正实时层可能存在的错误状态。 |
| **-1** | **Suspended (暂停)** | 赔率继续提供，但不应接受投注。 | 确认层很少直接发送 `Suspended` 状态，这通常是实时层的临时状态。但确认层发送的 `odds_change` 可以将市场从 `Suspended` 恢复到 `Active`。 |
| **0** | **Deactivated/Inactive (停用)** | 不再提供赔率，不接受投注。 | 确认层发送的 `Deactivated` 状态是权威的，用于永久或长期停用一个市场。 |
| **-3** | **Settled (已结算)** | 已发送结算消息，不再提供赔率。 | **确认层的核心状态**。当收到 `bet_settlement` 消息后，市场状态应更新为此。**重要**：已结算的市场在极少数情况下可能被 `bet_cancel` 消息取消，或被 `rollback_bet_settlement` 回滚。 |
| **-4** | **Cancelled (已取消)** | 市场已被官方取消。 | **确认层的最终状态之一**。通常由 `bet_cancel` 或 `fixture_change` (change_type=3) 消息触发。所有相关注单应作废。 |
| **-2** | **Handed over (交接)** | **信号状态**，表示生产者交接。 | 确认层也可能在数据恢复或生产者切换时发送此信号。处理方式与实时层类似：暂停市场，等待新生产者的权威消息。 |

#### 2.7.2. 确认层驱动的状态转换

确认层通过发送具有权威性的消息来驱动市场的最终状态转换。

- **`bet_settlement` → `Settled (-3)`**：
  - 这是最主要的状态转换。一旦 `bet_settlement` 消息被处理，相应的市场状态必须被更新为 `Settled`。
  - 这是对市场生命周期的“终结”信号（正常情况下）。

- **`bet_cancel` / `fixture_change` (type=3) → `Cancelled (-4)`**：
  - 当收到 `bet_cancel` 或赛事取消的 `fixture_change` 消息时，市场状态应更新为 `Cancelled`。
  - 这是一个永久性的、不可逆的状态。

- **`rollback_bet_settlement` → `Active (1)` 或 `Deactivated (0)`**：
  - 当一个结算被回滚时，市场状态需要从 `Settled (-3)` 恢复到之前的状态。
  - 这通常是 `Active` 或 `Deactivated`，取决于回滚前的市场状态。系统需要有能力将市场“复活”。

- **`odds_change` (来自确认层生产者) → `Active (1)` / `Deactivated (0)`**：
  - 确认层发送的 `odds_change` 消息可以强制更新市场状态，覆盖实时层的任何临时状态。
  - 例如，即使实时层将一个市场置为 `Suspended`，确认层的 `odds_change` 也可以直接将其恢复为 `Active`。

#### 2.7.3. 关键场景处理

- **结算后取消 (Settled → Cancelled)**：
  - 这是一个需要特别注意的场景。系统必须支持对已结算的市场执行“反结算”操作，即先撤销派彩，然后将注单标记为“已取消”并退款。

- **结算后回滚 (Settled → Active)**：
  - 同样需要“反结算”逻辑。在回滚资金后，市场状态需要恢复到 `Active` 或 `Deactivated`，以便进行后续操作（如重新结算或继续交易）。

> **核心原则**：确认层是市场状态的最终仲裁者。所有来自确认层的状态变更消息都具有最高优先级，并且必须被系统正确处理，以确保数据的一致性和业务的准确性。

---

## 3. 确认层处理原则与建议

### 3.1. 关键业务逻辑

#### 3.1.1. `certainty` 优先级处理

```
规则：certainty=2 > certainty=1

处理逻辑：
1. 收到 certainty=1 的结算 → 可以先派彩，但标记为"待确认"
2. 收到 certainty=2 的结算 → 必须覆盖 certainty=1 的结果
3. 如果结果不一致 → 执行冲正（扣回已派彩金额）
4. 如果结果一致 → 更新状态为"已确认"
```

#### 3.1.2. 回滚操作的事务性

```
事务边界：
BEGIN TRANSACTION
  1. 查找需要回滚的注单
  2. 更新注单状态为"未结算"
  3. 从用户账户扣除已派彩金额
  4. 记录交易流水
  5. 更新市场状态
COMMIT TRANSACTION

异常处理：
- 如果任何步骤失败 → ROLLBACK TRANSACTION
- 如果用户余额不足 → 允许负余额，触发人工风控
```

### 3.2. 技术建议

- **强制执行 `certainty` 优先级**：在代码层面硬编码 `certainty=2` 的绝对优先级。
- **事务隔离级别**：使用 `SERIALIZABLE` 或 `REPEATABLE READ` 隔离级别，防止并发问题。
- **冲正机制**：必须支持资金的双向流动（派彩和扣回）。
- **审计日志**：所有确认层操作必须记录完整的审计日志。

---

## 4. 双层机制协作示例

### 场景：进球误判后的修正流程

```
实时层：
1. odds_change (home_score=1) - Live Scout 判定主队进球
2. bet_stop (group=all) - 立即暂停所有盘口
3. odds_change (赔率大幅调整，市场重新开放)

确认层：
4. bet_settlement (certainty=1, result=1) - 实时结算，判定主队赢的注单赢
   → 系统先派彩 1000 元，标记为"待确认"

5. fixture_change (change_type=2) - 官方确认进球有效
   → 无需操作，等待最终结算

6. bet_settlement (certainty=2, result=0) - 官方确认进球无效，主队实际未赢
   → 系统执行冲正，扣回 1000 元，更新注单状态为"已输"
```

**双层机制的价值**：
- 实时层提供即时体验（快速派彩）。
- 确认层保证最终准确性（修正错误）。
- 用户体验和资金安全得到平衡。

---

**报告结束**
