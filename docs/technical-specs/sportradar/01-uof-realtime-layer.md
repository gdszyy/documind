---
title: Sportradar UOF 实时层消息处理规范
category: standard
type: integration
version: 2.0
status: active
createdAt: 2025-12-07
updatedAt: 2025-12-08
author: Manus AI
tags:
  - sportradar
  - uof
  - realtime
  - data-source
  - integration
description: Sportradar Unified Odds Feed 实时层消息类型、字段详解和处理逻辑的完整技术规范
reference: https://docs.sportradar.com/uof/en/overview
---

# Sportradar UOF 实时层消息处理规范

---

## 1. 实时层概述

实时层（Live Scout Layer）消息是 Sportradar UOF 双层信息处理机制的第一层，主要来源于 **Live Scout** 现场数据采集系统。这些消息是滚球（Live Betting）业务的核心驱动力，为用户提供即时的赔率更新和比赛状态。

**核心特点**：

- **高频率与低延迟**：比赛进行中持续推送，延迟通常在 1-3 秒内。
- **即时性与可修正性**：反映的是现场数据员的即时判断，因此数据可能被后续来自确认层的官方消息覆盖或回滚。
- **速度优先**：所有处理逻辑都应以优化响应速度为首要目标。

---

## 2. 核心消息类型分析

### 2.1. odds_change (实时赔率更新)

#### 2.1.1. 消息定位

`odds_change` 是实时层 **最核心、最频繁** 的消息类型，承载着比赛中盘口赔率和比赛状态的实时变化。在双层机制中，它主要反映 Live Scout 的即时判断，而非官方最终结果。

#### 2.1.2. 完整消息结构与字段详解

`odds_change` 消息的结构非常丰富，包含了从赛事基本信息到具体盘口赔率的完整数据链。

**根元素属性**

| 属性 | 数据类型 | 必需 | 业务含义 |
| :--- | :--- | :--- | :--- |
| `event_id` | 字符串 | 是 | 赛事唯一标识符，用于关联两层数据。 |
| `timestamp` | 长整型 | 是 | 消息生成时间戳（毫秒），**用于处理消息乱序**。 |
| `product` | 整数 | 是 | 消息来源产品。`1` (Live Odds) 代表实时层数据。 |

**核心子元素详解**

1.  **`<sport_event_status>` (比赛状态)**

    此元素报告与赛事相关的各种状态信息，其重要性不亚于赔率本身。

    *   **核心属性**

| 属性 | 业务含义 | 实时层处理要点 |
| :--- | :--- | :--- |
| `status` | 赛事的高级状态 (0:未开始, 1:进行中, 3:已结束) | 驱动整个赛事生命周期的核心状态机。 |
| `reporting` | 是否有现场数据员 (1:是, 0:否) | `1` 表示数据质量更高，延迟更低。 |
| `match_status` | 运动特定的比赛阶段代码 | 用于在前端显示详细的比赛进程，如“第一节”、“中场休息”等。 |
| `home_score` / `away_score` | 实时比分 | **可能被确认层修正**，是滚球玩法的重要依据。 |

    *   **比赛时间与暂停相关属性**

| 属性 | 业务含义 | 实时层处理要点 |
| :--- | :--- | :--- |
| `match_time` | 比赛已进行时间（分钟） | 用于前端显示比赛进程。 |
| `remaining_time` | 赛段剩余时间 | 倒计时显示，增加紧迫感。 |
| `stoppage_time` | 伤停补时时间 | 在常规时间结束后显示。 |
| `stoppage_time_announced` | 官方宣布的伤停补时时间 | 用于提前告知用户补时长度。 |
| `stopped` | 比赛是否暂停 (1:是, 0:否) | `1` 表示比赛暂停（非盘口暂停），前端应有明确提示。 |

    *   **运动特定属性（部分示例）**

| 运动 | 属性示例 | 业务含义 |
| :--- | :--- | :--- |
| 网球 | `serve`, `point_home`, `point_away` | 发球方，局内比分 |
| 美式足球 | `possession_team`, `down`, `yards_to_go` | 球权方，进攻档数，剩余码数 |
| 棒球 | `strikes`, `balls`, `outs`, `bases` | 好球数，坏球数，出局数，垒上情况 |

    *   **核心子元素：`<period_scores>` (赛段比分)**

        此元素包含每个赛段（如上下半场、各节）的比分详情，是展示详细赛况的关键。

        ```xml
        <period_scores>
          <period_score type="regular_period" number="1" home_score="0" away_score="1"/>
          <period_score type="regular_period" number="2" home_score="1" away_score="1"/>
        </period_scores>
        ```

    *   **其他子元素**：`sport_event_status` 还可能包含 `<results>` (最终赛果), `<statistics>` (统计数据) 等，应根据需要进行解析和存储。

2.  **`<odds>` (赔率信息)**

    此元素包含所有市场和赔率的更新。

    *   **特殊情况：空 `<odds/>` 元素**：如果消息中包含一个空的 `<odds/>` 元素，表示仅 `sport_event_status` 等其他信息发生了变化，但市场赔率未变。此时应仅更新比赛状态，不改变任何盘口或赔率。

3.  **`<market>` (市场/盘口)**

    描述特定市场的赔率更新。

| 属性 | 数据类型 | 业务含义 | 实时层处理要点 |
| :--- | :--- | :--- | :--- |
| `id` | 整数 | 市场唯一ID | 关联到具体的盘口定义。 |
| `status` | 整数 | **市场状态** | **核心字段**，决定盘口的可交易性。详见 **2.1.3 市场状态生命周期**。 |
| `specifiers` | 字符串 | 市场详细说明 | 用于区分同一市场的不同变体，如让分盘的具体分数 (`score=41.5`)。 |
| `favourite` | 整数 | (可选) 最平衡或推荐的市场线 | 值为 `1` 时，可用于辅助前端展示，突出主要盘口。 |
| `extended_specifiers` | 字符串 | (可选) 市场附加信息 | 用于前端显示的附加文本，不影响核心逻辑。 |

4.  **`<outcome>` (投注项)**

    描述特定投注项的赔率。

| 属性 | 数据类型 | 业务含义 | 实时层处理要点 |
| :--- | :--- | :--- | :--- |
| `id` | 字符串 | 投注项唯一ID | 如主队ID、客队ID、球员ID等。 |
| `odds` | 浮点数 | 实时赔率 | **高频变化**，需快速更新前端。 |
| `active` | 整数 | 投注项是否活跃 (1:是, 0:否) | `0` 表示该投注项不可投。 |
| `probabilities` | 浮点数 | (可选) 结果的概率 | 需单独配置开启，用于高级模型或前端展示。概率低于 `1e-10` 的结果不包含此属性。 |

5.  **其他可选元素**

    - **`<betting_status>`**：在 `betstop` 后出现，用于解释之前触发 `betstop` 的原因（如“进球”、“红牌”）。
    - **`<market_metadata>`**：包含 `betstop_at` 等信息，用于预设停盘时间。
    - **`<odds_generation_properties>`**：包含 `expected_totals` 等模型参数，用于自定义赔率模型。

#### 2.1.3. 市场状态生命周期与处理

根据 Sportradar 官方文档，市场状态（`market.status`）是描述盘口可交易性的核心概念，其生命周期远比简单的“开/关/停”复杂。它与比赛状态（`match_status`）是两个独立但相互关联的概念。

##### 2.1.3.1. 完整的市场状态列表

| Status ID | 状态名称 | 业务含义 | 实时层处理要点 |
| :--- | :--- | :--- | :--- |
| **1** | **Active (活跃)** | 赔率已提供，可以接受投注。 | 正常交易状态，前端应显示赔率并允许下注。 |
| **-1** | **Suspended (暂停)** | 赔率继续提供，但不应接受投注。 | 临时锁盘，通常由进球等关键事件触发。前端应显示赔率但**禁用下注**，并提示“暂停投注”。 |
| **0** | **Deactivated/Inactive (停用)** | 不再提供赔率，不接受投注。 | 盘口暂时不可用，但**可能重新激活**。前端应灰显或隐藏该盘口。 |
| **-3** | **Settled (已结算)** | 已发送结算消息，不再提供赔率。 | 盘口已结算。实时层通常不直接处理此状态，它更多是确认层的范畴。 |
| **-4** | **Cancelled (已取消)** | 市场已被官方取消。 | 盘口被取消。所有相关注单应作废。此为确认层消息驱动的最终状态。 |
| **-2** | **Handed over (交接)** | **信号状态**，非真实市场状态。表示生产者交接。 | 收到此状态后，应暂停市场，并等待新生产者的 `odds_change` 消息。若超过60秒无新消息，应视为异常。 |

##### 2.1.3.2. 市场状态转换与处理

市场的状态转换是动态的，实时层需要准确处理这些转换以保证业务的正确性。

- **Active (1) ↔ Suspended (-1)**：这是最常见的实时状态转换。比赛中的关键事件（如进球、红牌、VAR）会导致市场在 `Active` 和 `Suspended` 之间快速切换。系统需要立即响应，锁盘或开盘。

- **Active (1) → Deactivated (0)**：当一个市场或特定的线（line）在当前比赛进程下不再适用时，它会被停用。例如，“下一个进球”市场在进球后会被停用。

- **Deactivated (0) → Active (1)**：市场可以被重新激活。例如，一个被VAR取消的进球可能导致之前被停用的市场重新激活。

- **Handed over (-2) → Active (1)**：当数据生产者发生切换时（例如从赛前生产者切换到实时生产者），会先收到 `Handed over` 信号，然后由新的生产者发送 `Active` 状态的 `odds_change` 消息来接管市场。

> **核心原则**：**市场状态 (`market.status`) 决定盘口是否可交易，而比赛状态 (`match_status`) 决定赛事是否在滚球列表中。** 即使一个赛事的所有市场都被 `Deactivated`，只要 `match_status` 仍是“进行中”，该赛事就应继续显示在前端，只是所有盘口都不可点击。

#### 2.1.4. 实时层标准变体与业务处理

| 变体名称 | 描述 | 实时层业务反应 |
| :--- | :--- | :--- |
| **核心赔率更新** | 市场 `status=1`，`odds` 发生变化 | **立即更新**：实时更新数据库赔率，通过 WebSocket 推送前端。风控系统实时评估风险敞口。 |
| **市场暂停/激活** | 市场 `status` 在 `1`, `-1`, `0` 之间切换 | **立即锁盘/开盘**：更新盘口状态，前端显示锁盘或激活，并拒绝/允许新注单。通常由关键事件（进球、点球）触发。 |
| **仅比赛状态更新** | 消息包含一个空的 `<odds/>` 元素，但 `sport_event_status` 包含更新（如比分、比赛时间） | **状态同步**：仅更新比赛实时信息（如比分板），不改变任何盘口或赔率的状态。 |

#### 2.1.5. 实时层异常处理

| 异常场景 | 实时层处理方案 | 评估 |
| :--- | :--- | :--- |
| **消息乱序** | 基于 `timestamp` 进行幂等性处理，旧消息直接丢弃 | **高**：实时层必须保证只有最新数据生效 |
| **消息延迟** | 设置延迟阈值（如 5 秒），超时则告警并执行降级策略（如暂停盘口） | **高**：实时性是实时层的核心价值 |
| **市场 ID 不存在** | 数据同步校验，若 ID 不存在则告警，提示检查初始化数据 | **高**：避免数据孤岛 |
| **生产者交接超时** | 收到 `Handed over` 状态后，若超过 60 秒未收到新生产者的 `odds_change`，应触发告警 | **高**：表示生产者切换失败，可能导致数据中断 |

---

### 2.2. bet_stop (投注暂停信号)

#### 2.2.1. 消息定位

`bet_stop` 是实时层的高优先级控制信号，用于快速响应比赛中的突发事件（如进球、红牌），立即暂停投注以保护平台风险。

#### 2.2.2. 核心字段业务含义

| 字段名 | 业务含义 | 双层机制中的作用 |
| :--- | :--- | :--- |
| `event_id` | 赛事唯一标识符 | 确定暂停范围 |
| `group` | 暂停的市场范围 | `all` 表示全部市场，或指定市场组 ID |
| `timestamp` | 消息生成时间戳 | **实时层关键**：确保暂停指令的时效性 |

#### 2.2.3. 实时层业务处理

#### 2.2.4. 赛前 bet_stop 与市场状态处理

对于没有订阅滚球盘（Live Betting）的比赛，在开赛前，系统会收到一个 `bet_stop` 消息，用于停止赛前盘的投注。此场景下的市场状态处理有明确的规则：

-   **默认行为：暂停 (Suspended)**
    -   如果收到的 `bet_stop` 消息没有明确指定 `market_status` 属性（例如 `<bet_stop groups="all" ... />`），所有当前状态为 `Active` 的市场都应被标记为 **`Suspended` (status = -1)**。
    -   这是一种临时性的“锁盘”，后续的 `odds_change` 消息会继续推送这些市场的状态，并带有 `status="-1"`。

-   **明确指定：停用 (Deactivated)**
    -   只有当 `bet_stop` 消息中明确带有 `market_status="0"` 时，相关市场才应被视为 **`Deactivated` (status = 0)**。
    -   示例：
        ```xml
        <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
        <bet_stop groups="all" market_status="0" product="3" event_id="sr:match:64836668" timestamp="1765164661167" request_id="1765164659"/>
        ```

-   **特殊情况：直接通过 `odds_change` 停用**
    -   在某些特定产品中（如 Premium Cricket），可能不会使用 `bet_stop` 消息，而是直接通过 `odds_change` 消息将市场的 `status` 设置为 `0` 来停用盘口。

> **核心结论**：对于“没订阅滚球的普通情况”，收到的 `bet_stop` 消息应将市场状态理解为 `Suspended`，而不是直接 `Deactivated`，除非消息中明确指定了 `market_status="0"` 或后续的 `odds_change` 消息将市场状态更新为 `0`。

- **全市场暂停 (`group="all"`)**：立即暂停所有市场，更新状态为 `Suspended`，前端通过 WebSocket 收到通知后将所有盘口标记为"暂停投注"并阻止下注。
- **特定市场组暂停**：仅暂停指定市场组，其他市场保持不变。

> **注意**：实时层的 `bet_stop` 是临时性的，通常会在几秒后收到新的 `odds_change` 消息重新开盘。

---

### 2.3. fixture_change (赛事变更通知 - 实时变更)

#### 2.3.1. 消息定位

在实时层，`fixture_change` 主要用于通知**赛事时间变更**或**新增赛事**等需要立即响应的变更。

#### 2.3.2. 实时层关注的变体

| 变体名称 | `change_type` | 实时层业务反应 |
| :--- | :--- | :--- |
| **NEW** | `1` | **立即添加**：插入新赛事记录，触发盘口生成服务。 |
| **DATE_TIME** | `2` | **立即更新**：更新赛事开始时间，前端更新倒计时。**这是实时层最常见的变更**。 |
| **Unspecified** | 缺失 | **立即调用 API**：根据 Sportradar 示例，如果消息缺失 `change_type`，应立刻调用静态 API 获取该赛事的完整信息。 |

---

### 2.4. alive (实时层心跳监控)

#### 2.4.1. 消息定位

`alive` 消息是实时层数据流健康状态的生命线，用于监控 Live Odds 生产者是否正常运行。

#### 2.4.2. 核心字段与业务处理

| `subscribed` 值 | 描述 | 实时层业务反应 |
| :--- | :--- | :--- |
| **`1`** | **正常心跳** | **更新心跳时间**：重置"失活"计时器。 |
| **`0`** | **恢复指示心跳** | **立即暂停所有盘口**，并向 UOF API 发起 Recovery 请求。 |

> **异常处理**：对于 In-play 或即将开赛的赛事，若超过 15 秒未收到 `alive` 消息，应视为生产者宕机，立即暂停所有相关盘口，这是**极高优先级**的异常处理。

---

## 3. 实时层处理原则与建议

### 3.1. 核心原则

1.  **速度优先**：所有处理逻辑都应优化响应速度，保证低延迟。
2.  **幂等性**：基于 `timestamp` 确保旧消息不会覆盖新消息。
3.  **可修正性**：实时层数据可能被确认层覆盖，系统设计需支持冲正和回滚。
4.  **风险控制**：关键事件发生时，立即暂停盘口，等待确认层数据。

### 3.2. 与确认层的协作

- **实时层负责即时响应**，确认层负责最终准确性。
- **实时层的比分、赔率可能被修正**，前端应有相应提示（如“实时数据，仅供参考”）。
- **实时层的暂停是临时性的**，确认层的取消是永久性的。

### 3.3. 技术建议

- **WebSocket 推送优化**：实时层消息应使用增量推送，减少带宽消耗。
- **缓存策略**：实时层数据应使用短 TTL 缓存（如 5-10 秒）。
- **监控告警**：重点监控消息延迟、`alive` 缺失、API 调用失败、生产者交接超时等关键异常。

---

## 4. 附录：实时层消息流示例

以下是一个典型的足球比赛实时层消息流：

```
1. alive (product=1, subscribed=1) - 正常心跳
2. odds_change (赔率更新，主胜从 1.85 变为 1.90)
3. odds_change (比分更新，home_score=1, away_score=0)
4. bet_stop (group=all) - 进球后立即暂停所有市场
5. odds_change (market.status=-1) - 市场状态变为 Suspended
6. odds_change (赔率大幅调整，market.status=1) - 市场重新开放
7. alive (product=1, subscribed=1) - 正常心跳
8. fixture_change (change_type=2, 比赛延迟 10 分钟)
9. odds_change (market.status=-2) - 生产者交接开始
10. odds_change (product=3, market.status=1) - 新生产者接管
```

**关键观察点**：
- 进球后立即收到 `bet_stop`，随后 `odds_change` 将市场状态更新为 `Suspended`。
- 赔率调整后，新的 `odds_change` 将市场重新激活。
- `alive` 消息周期性出现，确保连接正常。
- 生产者切换时，会通过 `Handed over` 状态进行平滑过渡。

---

**报告结束**
