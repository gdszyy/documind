# Sportradar UOF 文档 - 图表位置指南

## 概述

本指南详细说明了 6 个 Mermaid 流程图在原始分析文档中的最佳放置位置，以及每个图表的用途和相关内容。

---

## 图表位置详细说明

### 图表 #1：消息处理流程图
**文件名:** `message_processing_flow.png`

**放置位置:** 第一部分 → 1.2 消息处理流程

**文档位置详情:**
```
## 第一部分：消息处理机制
  └─ ### 1.2 消息处理流程
      └─ [【图表占位符】消息处理流程图]
         ↓
         (消息处理应遵循其优先级...)
```

**图表内容:**
- 消息接收和初步分类
- 高优先级消息处理路径（红色）
  - `fixture_change` → 调用 API 获取赛事信息
  - `odds_change` → 更新 Market 状态和赔率
  - `bet_stop` → 暂停指定 Market
  - `bet_cancel` → 触发退款流程
- 低优先级消息处理路径（蓝色）
  - `bet_settlement` → 结算投注
  - `rollback_bet_settlement` → 撤销结算
  - `rollback_bet_cancel` → 恢复被取消投注
  - `alive` → 更新心跳
- 最终的数据库更新步骤
- 消息处理循环

**相关文本内容:**
- 消息优先级的定义
- 高优先级 vs 低优先级消息的特点
- 消息处理顺序的重要性

**使用场景:**
- 理解消息处理的整体流程
- 设计消息队列架构
- 实现消息分发逻辑

---

### 图表 #2：投注可用性层级图
**文件名:** `betting_availability_hierarchy.png`

**放置位置:** 第一部分 → 1.3 投注可用性层级

**文档位置详情:**
```
## 第一部分：消息处理机制
  └─ ### 1.3 投注可用性层级
      └─ [【图表占位符】投注可用性层级图]
         ↓
         (一个投注项是否对用户开放...)
```

**图表内容:**
- 四层检查的决策树
  - 第一层：系统连接正常检查（20 秒内收到消息）
  - 第二层：生产者正常检查（未被标记为宕机）
  - 第三层：Market 状态检查（status = 1）
  - 第四层：投注项活跃性检查（active = true）
- 每层的失败路径（❌ 投注停止）
- 所有层都通过的成功路径（✅ 投注可用）
- 最终的投注状态（OPEN 或 STOPPED）

**相关文本内容:**
- 四层检查机制的详细说明
- 每层检查的具体条件
- 任何条件不满足的影响

**使用场景:**
- 实现投注可用性检查
- 调试投注被停止的原因
- 优化投注决策逻辑

---

### 图表 #3：Market 状态转换图
**文件名:** `market_state_diagram.png`

**放置位置:** 第二部分 → 2.2 Market 状态转换图

**文档位置详情:**
```
## 第二部分：Market 状态流转
  └─ ### 2.2 Market 状态转换图
      └─ [【图表占位符】Market 状态转换图]
         ↓
         (核心转换路径...)
```

**图表内容:**
- 6 种 Market 状态的完整转换图
  - Active (1) - 中心枢纽
  - Suspended (-1)
  - Deactivated (0)
  - Settled (-3)
  - Cancelled (-4)
  - Handed Over (-2)
- 从 Active 出发的所有可能转换路径
- 各个状态的特征说明
  - 投注可用性
  - 赔率提供情况
  - 状态持续时间
- 状态转换的触发消息类型
  - `odds_change(status=X)`
  - `bet_stop`
  - `bet_settlement`
  - `bet_cancel`
  - `rollback_bet_settlement`
- 可逆和不可逆的转换标记

**相关文本内容:**
- Market 状态定义表
- 核心转换路径的说明
- 各个状态的业务含义

**使用场景:**
- 理解 Market 可能的状态变化
- 验证状态转换是否合法
- 处理异常状态转换

---

### 图表 #4：进球处理时序图
**文件名:** `goal_handling_sequence.png`

**放置位置:** 第二部分 → 2.3 关键场景一：进球处理

**文档位置详情:**
```
## 第二部分：Market 状态流转
  └─ ### 2.3 关键场景一：进球处理
      └─ [【图表占位符】进球处理时序图]
         ↓
         (处理流程...)
```

**图表内容:**
- 时间轴（从进球发生到赔率稳定）
- 参与者：Betradar 系统、客户端系统、本地数据库
- 消息序列：
  1. 进球发生 → `odds_change(status=-1)` → Market 变为 Suspended
  2. 进球确认 → `odds_change(status=1)` → Market 恢复为 Active
  3. 赔率重新平衡 → `odds_change(status=0)` → 某些 Market 变为 Deactivated
  4. 新赔率线条 → `odds_change(status=1)` → 新 Market 变为 Active
- 客户端的响应动作
  - 灰显 Market
  - 恢复 Market 显示
  - 更新赔率
- 投注状态的变化
  - 投注暂停
  - 投注恢复
  - 新投注线条可用

**相关文本内容:**
- 进球处理的完整流程说明
- 每个步骤的时间顺序
- Market 状态的变化原因

**使用场景:**
- 理解进球时的 Market 状态变化
- 实现进球处理逻辑
- 调试进球相关的问题

---

### 图表 #5：生产者交接时序图
**文件名:** `handover_sequence.png`

**放置位置:** 第二部分 → 2.4 关键场景二：生产者交接 (Handover)

**文档位置详情:**
```
## 第二部分：Market 状态流转
  └─ ### 2.4 关键场景二：生产者交接 (Handover)
      └─ [【图表占位符】生产者交接时序图]
         ↓
         (处理步骤...)
```

**图表内容:**
- 时间轴（从赛事开始时刻到交接完成）
- 参与者：Prematch 生产者、客户端系统、Live Odds 生产者、本地数据库
- 消息序列：
  1. Prematch 发送最终消息
     - Market A: status=-2 (Handed Over)
     - Market B: status=0 (Deactivated)
     - Market C: status=1 (Active)
  2. 客户端处理
     - Market A: 暂停投注，启动 60 秒计时器
     - Market B: 灰显
     - Market C: 保持活跃
  3. Live Odds 发送赔率
     - Market A: status=1 (Active)
     - 更新赔率
  4. 客户端恢复
     - Market A: 清除计时器，恢复投注
     - 更新赔率
- 60 秒超时的错误处理场景
  - 记录错误
  - 可能需要人工介入

**相关文本内容:**
- 生产者交接的处理步骤
- Handed Over 状态的含义
- 60 秒超时的最佳实践

**使用场景:**
- 实现 Handover 逻辑
- 处理生产者交接期间的状态
- 设置超时检测

---

### 图表 #6：赛事生命周期图
**文件名:** `event_lifecycle.png`

**放置位置:** 第二部分 → 2.5 赛事生命周期

**文档位置详情:**
```
## 第二部分：Market 状态流转
  └─ ### 2.5 赛事生命周期
      └─ [【图表占位符】赛事生命周期图]
         ↓
         (生命周期阶段详解...)
```

**图表内容:**
- 赛事的完整生命周期阶段（从左到右）
  1. **赛事预订** (Prematch 阶段, T=-1h)
  2. **赛事开始前** (Handover 准备, T=-30s)
  3. **赛事开始** (Handover 执行, T=0)
  4. **赛事进行中** (Live 阶段, T=0~90min)
  5. **赛事结束** (Post-match 阶段, T=90+)
  6. **投注结算** (Settled 阶段, T=90+30min)
  7. **完全关闭** (Archived 阶段)
- 每个阶段的详细信息
  - Market 状态特征
  - 赔率数据来源
  - 投注可用性
  - 特点描述
- 阶段之间的转换箭头
- 颜色编码（不同阶段用不同颜色）

**相关文本内容:**
- 生命周期阶段的详细说明表
- 每个阶段的 Market 状态
- 每个阶段的赔率来源
- 每个阶段的投注可用性

**使用场景:**
- 理解赛事的完整生命周期
- 规划数据库清理策略
- 实现赛事状态管理

---

## 图表集成建议

### 1. 文档格式
- 在 Markdown 文档中，使用以下格式插入图表：
  ```markdown
  ![图表标题](图表文件名.png)
  ```

### 2. 图表尺寸
- 建议图表宽度为 800-1000px，以适应常见的文档阅读宽度
- 图表应该清晰可读，不应该过小

### 3. 图表说明
- 每个图表前应有简短的介绍说明
- 图表后应有关键要点的总结
- 应指出图表与相关文本内容的关系

### 4. 图表顺序
- 图表应按照逻辑顺序放置
- 先放置概览图表（消息处理流程、投注可用性层级）
- 再放置细节图表（Market 状态转换、具体场景）
- 最后放置综合图表（赛事生命周期）

### 5. 交叉引用
- 在文档的其他位置提到某个图表时，应使用"见图表 #X"的方式
- 在"图表索引"部分列出所有图表及其位置

---

## 快速参考表

| 图表 # | 名称 | 文件名 | 放置节点 | 优先级 |
|------|------|--------|--------|-------|
| #1 | 消息处理流程图 | `message_processing_flow.png` | 1.2 | 高 |
| #2 | 投注可用性层级图 | `betting_availability_hierarchy.png` | 1.3 | 高 |
| #3 | Market 状态转换图 | `market_state_diagram.png` | 2.2 | 高 |
| #4 | 进球处理时序图 | `goal_handling_sequence.png` | 2.3 | 中 |
| #5 | 生产者交接时序图 | `handover_sequence.png` | 2.4 | 中 |
| #6 | 赛事生命周期图 | `event_lifecycle.png` | 2.5 | 中 |

---

## 使用示例

### 示例 1：在 Markdown 中插入图表

```markdown
### 1.2 消息处理流程

下图展示了系统如何接收、分类和处理不同优先级的消息：

![消息处理流程图](message_processing_flow.png)

消息处理应遵循其优先级，以确保关键信息的及时响应。
```

### 示例 2：在 HTML 中插入图表

```html
<h3>1.2 消息处理流程</h3>
<p>下图展示了系统如何接收、分类和处理不同优先级的消息：</p>
<img src="message_processing_flow.png" alt="消息处理流程图" width="800">
<p>消息处理应遵循其优先级，以确保关键信息的及时响应。</p>
```

### 示例 3：在 PDF 中插入图表

```latex
\subsection{消息处理流程}

下图展示了系统如何接收、分类和处理不同优先级的消息：

\includegraphics[width=0.8\textwidth]{message_processing_flow.png}

消息处理应遵循其优先级，以确保关键信息的及时响应。
```

---

## 总结

通过按照本指南的建议放置这 6 个图表，您可以创建一份视觉效果良好、易于理解的综合分析文档。这些图表不仅可以帮助读者快速理解复杂的流程，还可以作为团队培训和讨论的基础。
