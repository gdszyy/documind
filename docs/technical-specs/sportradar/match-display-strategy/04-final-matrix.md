# 比赛展示策略最终完整矩阵

**作者:** Manus AI  
**日期:** 2025年12月09日  
**版本:** 2.0 (最终版)

---

## 1. 核心定义

### 1.1 可用盘口的定义

**可用盘口** = 所有可以转换为 Active 的状态：
- `1` (Active)：活跃，可投注 ✅
- `-1` (Suspended)：暂停，但可能恢复为 Active ✅
- `-2` (Handed Over)：交接中，会转换为 Active ✅

**不可用盘口** = 永久性停用的状态：
- `0` (Deactivated)：停用，不会再恢复 ❌
- `-3` (Settled)：已结算，最终状态 ❌
- `-4` (Cancelled)：已取消，最终状态 ❌

### 1.2 关键字段

| 字段 | 说明 |
| :--- | :--- |
| `available_markets_count` | 可用盘口数量（status in 1, -1, -2） |
| `ever_had_available_markets` | 是否曾经有过可用盘口 |
| `has_live_subscription` | 是否订阅滚球赔率 |
| `sport_event_status` | 比赛状态（not_started, live, ended, closed） |

---

## 2. 完整策略矩阵

| 订阅状态 | 比赛状态 | 当前可用盘口 | 曾有可用盘口 | 是否交接 | 后端返回 | 前端展示 | 展示状态 | 用户提示 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **滚球订阅** | `not_started` | > 0 | - | - | ✅ 是 | 正常展示 | `prematch_active` | - |
| **滚球订阅** | `not_started` | = 0 | **是** | - | ✅ 是 | 展示比赛 | `prematch_no_markets` | "暂无可用盘口" |
| **滚球订阅** | `not_started` | = 0 | 否 | - | ✅ 是 | 展示比赛 | `prematch_waiting_markets` | "即将开盘" |
| **滚球订阅** | `live` | > 0 | - | 否 | ✅ 是 | 正常展示 | `live_active` | - |
| **滚球订阅** | `live` | = 0 | - | **是** | ✅ 是 | 展示比赛 | `handover` | "盘口准备中..." |
| **滚球订阅** | `live` | = 0 | - | 是（超时） | ✅ 是 | 展示比赛 | `handover_timeout` | "盘口暂不可用，请稍候" |
| **滚球订阅** | `live` | = 0 | **是** | 否 | ✅ 是 | 展示比赛 | `live_no_markets` | "暂无可用盘口" |
| **滚球订阅** | `live` | = 0 | 否 | 否 | ✅ 是 | 展示比赛 | `live_waiting_markets` | "盘口准备中..." |
| **滚球订阅** | `ended`/`closed` | - | - | - | ❌ 否 | 不展示 | `ended` | - |
| **仅赛前** | `not_started` | > 0 | - | - | ✅ 是 | 正常展示 | `prematch_active` | - |
| **仅赛前** | `not_started` | = 0 | **是** | - | ✅ 是 | 展示比赛 | `prematch_no_markets` | "暂无可用盘口" |
| **仅赛前** | `not_started` | = 0 | 否 | - | ❌ 否 | 不展示 | - | - |
| **仅赛前** | `live` | - | - | - | ❌ 否 | 不展示 | `started` | - |
| **仅赛前** | `ended`/`closed` | - | - | - | ❌ 否 | 不展示 | `ended` | - |

---

## 3. 决策流程图

```
开始判断
  │
  ├─ 比赛是否结束？（带兜底逻辑）
  │   ├─ 是 → ❌ 不展示
  │   └─ 否 → 继续
  │
  ├─ 是否订阅滚球？
  │   │
  │   ├─ 是（订阅滚球）
  │   │   │
  │   │   ├─ 比赛状态是 not_started 或 live？
  │   │   │   ├─ 是 → ✅ 展示
  │   │   │   │   │
  │   │   │   │   ├─ 当前可用盘口 > 0？
  │   │   │   │   │   ├─ 是 → 正常展示盘口
  │   │   │   │   │   └─ 否 → 继续判断
  │   │   │   │   │
  │   │   │   │   ├─ 是否在交接？
  │   │   │   │   │   ├─ 是 → 提示"盘口准备中..."
  │   │   │   │   │   └─ 否 → 继续判断
  │   │   │   │   │
  │   │   │   │   ├─ 曾有可用盘口？
  │   │   │   │   │   ├─ 是 → 提示"暂无可用盘口"
  │   │   │   │   │   └─ 否 → 提示"即将开盘"或"盘口准备中..."
  │   │   │   │
  │   │   │   └─ 否 → ❌ 不展示
  │   │   │
  │   │   └─ 否 → ❌ 不展示
  │   │
  │   └─ 否（仅赛前订阅）
  │       │
  │       ├─ 比赛是否已开赛？（带兜底逻辑）
  │       │   ├─ 是 → ❌ 不展示
  │       │   └─ 否 → 继续
  │       │
  │       ├─ 比赛状态是 not_started？
  │       │   ├─ 是 → 继续判断
  │       │   │   │
  │       │   │   ├─ 当前可用盘口 > 0？
  │       │   │   │   ├─ 是 → ✅ 展示，正常显示盘口
  │       │   │   │   └─ 否 → 继续判断
  │       │   │   │
  │       │   │   ├─ 曾有可用盘口？
  │       │   │   │   ├─ 是 → ✅ 展示，提示"暂无可用盘口"
  │       │   │   │   └─ 否 → ❌ 不展示
  │       │   │
  │       │   └─ 否 → ❌ 不展示
  │       │
  │       └─ 否 → ❌ 不展示
```

---

## 4. 关键场景说明

### 场景 1：交接阶段（滚球订阅 + live + 无可用盘口 + 交接中）

**用户需求**：确保热门比赛在交接阶段不会"消失"

**策略**：
- ✅ 继续展示比赛
- 🔄 显示加载动画
- 💬 提示"盘口准备中..."
- ⏱️ 如果超过60秒，提示"盘口暂不可用，请稍候"

### 场景 2：盘口全部停用（任意订阅 + 任意状态 + 曾有可用盘口 + 现在全部停用）

**用户需求**：即使盘口全部停用，比赛信息依然可见

**策略**：
- ✅ 继续展示比赛
- ⚠️ 显示警告图标
- 💬 提示"暂无可用盘口"
- 📊 显示盘口统计（总数、停用数、结算数）
- ⏱️ 显示最后可用时间

### 场景 3：从未有盘口（仅赛前订阅 + not_started + 从未有可用盘口）

**用户需求**：避免展示"空比赛"

**策略**：
- ❌ 不展示比赛
- 📝 记录日志，便于排查

### 场景 4：状态判断兜底（消息延迟/丢失）

**用户需求**：不完全依赖 Sportradar 的单一状态字段

**策略**：
- 🔍 多维度判断（官方状态、时间、比分、盘口）
- ⏰ 定期检查任务（每5分钟）
- 🔔 异常告警（超时、状态异常）
- 📝 完整日志记录

---

## 5. 实现检查清单

### 5.1 数据库字段

- [ ] `has_live_subscription` - 是否订阅滚球
- [ ] `sport_event_status` - 比赛状态
- [ ] `available_markets_count` - 可用盘口数量（status in 1, -1, -2）
- [ ] `ever_had_available_markets` - 是否曾有可用盘口
- [ ] `first_market_available_at` - 首次有可用盘口的时间
- [ ] `last_market_available_at` - 最后一次有可用盘口的时间
- [ ] `is_in_handover` - 是否在交接中
- [ ] `handover_started_at` - 交接开始时间
- [ ] `handover_timeout` - 交接是否超时
- [ ] `last_message_at` - 最后收到消息的时间
- [ ] `fallback_ended` - 通过兜底逻辑判断为已结束
- [ ] `fallback_ended_reason` - 兜底判断结束的原因

### 5.2 核心函数

- [ ] `process_odds_change_v2()` - 处理 odds_change 消息
- [ ] `should_display_match_v3()` - 判断是否应该展示
- [ ] `determine_display_status()` - 判断展示状态
- [ ] `is_match_ended_with_fallback()` - 判断是否结束（带兜底）
- [ ] `is_match_started_with_fallback()` - 判断是否开赛（带兜底）
- [ ] `get_displayable_matches_v2()` - 获取应展示的比赛列表

### 5.3 定期任务

- [ ] `check_stale_matches()` - 检查状态异常的比赛（每5分钟）
- [ ] `check_deactivated_markets()` - 检查盘口全部停用的比赛（每10分钟）

### 5.4 监控告警

- [ ] 交接超时率 > 5%
- [ ] 交接平均时长 > 30秒
- [ ] 消息延迟 > 5秒
- [ ] 盘口全部停用比赛数 > 10
- [ ] 盘口停用持续时长 > 30分钟
- [ ] 兜底判断触发率 > 10%

### 5.5 前端实现

- [ ] 渲染比赛状态提示（8种状态）
- [ ] 渲染盘口列表（含空状态）
- [ ] 实时更新处理（WebSocket）
- [ ] CSS 样式（交接、停用、等待）

### 5.6 测试用例

- [ ] 滚球订阅 + 交接阶段 → 应该展示
- [ ] 滚球订阅 + 盘口全部停用 → 应该展示
- [ ] 仅赛前 + 曾有盘口但停用 → 应该展示
- [ ] 仅赛前 + 从未有盘口 → 不应该展示
- [ ] 消息超时判断比赛结束
- [ ] 计划时间判断比赛开赛
- [ ] 可用盘口数量计算

---

## 6. 配置参数

```python
# 兜底逻辑配置
FALLBACK_CONFIG = {
    'message_timeout_seconds': 900,           # 消息超时阈值（15分钟）
    'scheduled_time_buffer_minutes': 15,     # 计划时间缓冲（15分钟）
    'duration_exceed_multiplier': 1.5,       # 时长超限倍数
    'check_interval_minutes': 5,             # 定期检查间隔（5分钟）
}

# 交接配置
HANDOVER_CONFIG = {
    'timeout_seconds': 60,                   # 交接超时阈值（60秒）
}

# 盘口停用配置
DEACTIVATED_CONFIG = {
    'alert_duration_minutes': 30,            # 停用持续时长告警阈值（30分钟）
    'check_interval_minutes': 10,            # 定期检查间隔（10分钟）
}

# 运动时长配置（分钟）
SPORT_DURATIONS = {
    1: {'max': 120, 'min': 90},    # 足球
    2: {'max': 150, 'min': 48},    # 篮球
    5: {'max': 240, 'min': 60},    # 网球
    12: {'max': 210, 'min': 60},   # 冰球
    16: {'max': 240, 'min': 60},   # 美式足球
    23: {'max': 180, 'min': 60},   # 排球
}
```

---

## 7. 快速参考

### 7.1 展示状态速查表

| 展示状态 | 前端提示 | 盘口显示 |
| :--- | :--- | :--- |
| `prematch_active` | - | 正常显示 |
| `prematch_no_markets` | "暂无可用盘口" | 空状态 + 统计 |
| `prematch_waiting_markets` | "即将开盘" | 空状态 |
| `live_active` | - | 正常显示 |
| `live_no_markets` | "暂无可用盘口" | 空状态 + 统计 |
| `live_waiting_markets` | "盘口准备中..." | 空状态 + 加载 |
| `handover` | "盘口准备中..." | 空状态 + 加载 |
| `handover_timeout` | "盘口暂不可用，请稍候" | 空状态 + 警告 |

### 7.2 判断逻辑速查

**订阅了滚球**：
- ✅ not_started 或 live → 展示
- ❌ ended 或 closed → 不展示

**未订阅滚球**：
- ✅ not_started + (有可用盘口 或 曾有可用盘口) → 展示
- ❌ not_started + 从未有可用盘口 → 不展示
- ❌ live 或 ended 或 closed → 不展示

---

## 8. 总结

这套完整的策略矩阵解决了以下核心问题：

1. ✅ **交接阶段不丢失比赛**：订阅滚球的比赛在交接时继续展示
2. ✅ **盘口停用不丢失比赛**：曾有盘口的比赛即使停用也继续展示
3. ✅ **状态判断有兜底**：多维度交叉验证，不完全依赖单一数据源
4. ✅ **用户提示清晰明确**：8种展示状态，每种都有对应的提示
5. ✅ **监控告警完善**：关键指标全覆盖，异常及时发现

通过这套方案，可以确保用户在任何情况下都能获得连续、一致、清晰的体验！
